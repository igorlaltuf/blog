---
title: Como usar o pacote sidraR
author: ''
date: '2022-01-21'
slug: como-usar-o-pacote-sidrar
categories: []
tags: []
subtitle: ''
summary: ''
authors: []
lastmod: '2022-01-19T11:21:04-03:00'
featured: no
image:
caption: ''
focal_point: ''
preview_only: no
projects: []
---

O pacote sidraR permite acessar os dados do [Sidra](https://sidra.ibge.gov.br/) - Sistema IBGE de Recuperação Automática diretamente pelo R. No exemplo de hoje, vamos fazer um levantamento para tentar responder a seguinte pergunta: Quais foram os municípios brasileiros responsáveis pela maior parte do valor de soja produzido nas regiões Norte e Centro-Oeste em 2020?

Como o pacote está no [CRAN](https://cran.r-project.org/web/packages/sidrar/index.html), a instalação será pelo comando:
```r
install.packages('sidrar')
```

```{r include=FALSE}
library(sidrar)
library(dplyr)
library(stringr)
```

A função abaixo permite que busquemos por determinadas palavras-chave nos títulos das tabelas do IBGE. **Importante**: não é permitido usar acentos nessa função.

```{r attr.output='style="max-height: 500px;"', cache=TRUE, paged.print=FALSE}
x <- search_sidra('lavouras temporarias quantidade produzida')
x
```

Após uma breve leitura dos nomes das tabelas, percebemos que a informação que precisamos está na Tabela 1612: Área plantada, área colhida, quantidade produzida, rendimento médio e valor da produção das lavouras temporárias.

É por meio da função get_sidra() que conseguimos baixar os dados do IBGE para o R. Por meio dos atributos da função eu consigo determinar o nível de detalhe do dado baixado (microrregião, município, estado etc), filtrar apenas as informações de uma região, e até mesmo selecionar uma variável específica. 

Como o objetivo aqui é baixar os dados com o valor da produção, eu seleciono a variável número 215 (valor da produção) por meio do atributo variable. O problema é que ao usar a função get_sidra para baixar os dados da tabela, somos surpreendidos com a mensagem: "Quantidade de valores solicitados X linhas excedeu o limite: 50000". Ou seja, existe uma limitação de que os dados baixados sejam de apenas 50.000 por requisição. Para contornar essa limitação, a solução foi fazer uma requisição para cada região e ir armazenando os resultados em uma tabela que criativamente foi chamada de "tabela".

```{r echo=TRUE, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
regiao <- c(1,5)
tabela <- data.frame()

for(i in regiao){
  x <- get_sidra(x = 1612, # código da tabela no Sidra
                 geo = 'City', # nível de detalhe espacial da informação
                 geo.filter = list("Region" = i), #região
                 variable = 215, # variável de interesse
                 period = as.character(2020)
                 )
tabela <- rbind(tabela,x)
}
```

Podemos ver as primeiras linhas da nova tabela abaixo.

```{r message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE, attr.output='style="max-height: 400px;"'}
head(tabela)
```

Agora vamos filtrar a produção de soja, selecionar apenas aquelas variáveis que serão usadas, substituir os valores faltantes por zero, remover os municípios que tem valor igual a zero e classificar os valores.

```{r message=FALSE, warning=FALSE, attr.output='style="max-height:400px;"', cache=FALSE, paged.print=FALSE}
tabela_class <- tabela %>%
  janitor::clean_names() %>%
  select(5,6,7,9,13) %>%
  replace(is.na(.), 0) %>% 
  dplyr::filter(produto_das_lavouras_temporarias %in% "Soja (em grão)",
                valor > 0) %>%
  arrange(desc(valor)) 

tabela_class <- tabela_class %>% 
  mutate(class = case_when(
         valor <= summary(tabela_class$valor)[2] ~ "Baixo",
         valor <= summary(tabela_class$valor)[3] ~ "Médio Baixo",
         valor <= summary(tabela_class$valor)[5] ~ "Médio Alto",
         valor > summary(tabela_class$valor)[5] ~ "Alto"
         ),
         class = factor(class,
                        levels = c("Baixo","Médio Baixo","Médio Alto","Alto"))
         )
tabela_class$municipio_codigo <- as.double(tabela_class$municipio_codigo)
head(tabela)
```

O resultado pode ser visto no mapa abaixo:

```{r message=FALSE, warning=FALSE}
library(mapview)
library(geobr)
library(RColorBrewer)
mapa_soja <- geobr::read_municipality(showProgress = F) %>% 
  filter(str_detect(code_state, "^1|^5")) %>% 
  left_join(tabela_class, by = c('code_muni' = 'municipio_codigo'))

mapview::mapview(mapa_soja, zcol = "class", label = 'name_muni', col.regions = brewer.pal(4, "YlOrRd"))
```











